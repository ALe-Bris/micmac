#ifndef CFEATHERINGANDMOSAICKING_H
#define CFEATHERINGANDMOSAICKING_H
#include "cimgeo.h"


class  cFeatheringAndMosaicOrtho
{
    public:
    std::string mDir,mTmpDir;
    cFeatheringAndMosaicOrtho(int argc,char ** argv);
    void ChamferNoBorder(Im2D<U_INT1,INT> i2d) const;
    template <class T,class TB> void SaveTiff(std::string aName,  Im2D<T,TB> * aIm);

    void ChamferDist4AllOrt();   // feathering along seam line is determined by the distance from the seamline, which is measured by Chamfer morphological filter
    void WeightingNbIm1and2();   // gaussian-distance weighting of 2 images in feathering area
    void WeightingNbIm3();       // if 3 images, should first blend 2 ortho and subsequently blend the result with the third ortho
    void ComputeMosaic();
    void GenLabelTable();        // usually generate by tawny, but can be generated by this app (not that good than tawny but at least I learn to manipulate these stuff)
    void LoadRadiomEgalLinMod(); // load radiometric egalisation models in order to apply them prior to mosaicking
    int writeTFW(std::string aNameTiffFile, Pt2dr aGSD, Pt2dr aXminYmax);
    void banniereFeathering();

    private:
    std::map<int, cImGeo*> mIms; // key=label
    std::map<int, Im2D_REAL4>   mIm2Ds;
    std::map<int, Im2D_INT2>  mChamferDist;
    std::map<int, Im2D_REAL4>   mImWs;
    //std::map<int, Im2D_U_INT1>  mBlendingArea;
    //std::map<int, Im2D_U_INT1>  mMosaicArea;
    std::string mNameMosaicOut, mFullDir, mLabel;
    int mDist;
    std::list<std::string> mLFile;
    cInterfChantierNameManipulateur * mICNM;
    Box2dr mBoxOverlapTerrain;
    double mLambda;
    // coin de l'ortho
    Pt2dr aCorner;
    Pt2di sz;
    cFileOriMnt MTD;
    bool mDebug;
    Im1D_REAL4 lut_w;

    Im2D_REAL4 mosaic;
    Im2D_REAL4 NbIm,PondInterne;
    // sum of chamfer distance , on outside the enveloppe (positive value) and on inside the enveloppe (negative value)
    Im2D_INT4 mSumDistInter;
    Im2D_INT4 mSumDistExt;
    // to check that sum weighting is equal to 1 everywhere
    Im2D_REAL4 mSumWeighting;
    Im2D_U_INT1 label;

    std::string KeyAssocNameOrt2PC(std::string aOrtName);
    std::string KeyAssocNameOrt2Incid(std::string aOrtName);
    std::string KeyAssocNameOrt2TFW(std::string aOrtName);
    void checkParam();

};

#endif // CFEATHERINGANDMOSAICKING_H
